<!doctype html>
<html>
    <head>
			<script type="text/javascript" src="/homey.js" data-origin="settings"></script>
    </head>
    <body>
        <h1 data-i18n="Plugwise2py settings"> </h1>
        <fieldset>
            <legend data-i18n="MQTT broker settings"> </legend>
            <div class="field row">
                <label for="ip_mqtt" data-i18n="ip_mqtt"> </label>
                <input id="ip_mqtt" type="text" placeholder="e.g. 192.168.1.100" value="" />
            </div>
            <div class="field row">
                <label for="port_mqtt" data-i18n="port_mqtt"> </label>
                <input id="port_mqtt" type="number" value="1883" />
            </div>
            <div class="field row">
                <label for="username_mqtt" data-i18n="username_mqtt"> </label>
                <input id="username_mqtt" type="text" placeholder="optional" value="" />
            </div>
            <div class="field row">
              <label for="password_mqtt" data-i18n="password_mqtt"> </label>
              <input id="password_mqtt" type="password" value="" />
            </div>

            <div id="testresult"></div>

            <button class="left" id="button_clear" data-i18n="Clear"> </button>
            <button class="left" id="button_test" data-i18n="Test"> </button>
            <button class="right" id="button_save" data-i18n="Save"> </button>

        </fieldset>

        <fieldset>
            <legend data-i18n="Plugwise2py webinterface settings"> </legend>
            <div class="field row">
                <label for="ip_pw2py" data-i18n="ip_pw2py"> </label>
                <input id="ip_pw2py" type="text" placeholder="e.g. 192.168.1.100" value="" />
            </div>
            <div class="field row">
                <label for="port_pw2py" data-i18n="port_pw2py"> </label>
                <input id="port_pw2py" type="number" value="8000" />
            </div>
            <button class="left" id="pw2py_control" data-i18n="Control"> </button>
            <button class="left" id="pw2py_config" data-i18n="Config">  </button>
            <button class="right" id="pw2py_save" data-i18n="Save"> </button>
        </fieldset>

        <script type="text/javascript">

        var saveData;

        // triggered when user opens settings page
        function onHomeyReady(Homey){
					var ipMqttElement = document.getElementById('ip_mqtt');
					var portMqttElement = document.getElementById('port_mqtt');
					var usernameMqttElement = document.getElementById('username_mqtt');
					var passwordMqttElement = document.getElementById('password_mqtt');
					var testResultElement = document.getElementById('testresult');
					var clearElement = document.getElementById('button_clear');
					var testElement = document.getElementById('button_test');
					var saveElement = document.getElementById('button_save');
					var ipPw2pyElement = document.getElementById('ip_pw2py');
					var portPw2pyElement = document.getElementById('port_pw2py');
					var pw2pyControlElement = document.getElementById('pw2py_control');
					var pw2pyConfigElement = document.getElementById('pw2py_config');
					var Pw2pySaveElement = document.getElementById('pw2py_save');

          testResultElement.innerHTML = " ";
          saveElement.disabled = true; // Disable save button until settings have been checked

          Homey.get('settings_pw2py', function(err, storedData) {
            if (err) {
              console.log(err);
            } else {
              //console.log('got data: ', storedData);
              if ((storedData != null) && (storedData != undefined)) {
                ipPw2pyElement.value = storedData.ip_pw2py;
                portPw2pyElement.value = storedData.port_pw2py;
              }
            }
          });

          Homey.get('settings', function(err, storedData) {
            if (err) {
              console.log(err);
            } else {
              //console.log('got data: ', storedData);
              if ((storedData != null) && (storedData != undefined)) {
                ipMqttElement.value = storedData.ip_mqtt;
                portMqttElement.value = storedData.port_mqtt;
                usernameMqttElement.value = storedData.username_mqtt;
                passwordMqttElement.value = storedData.password_mqtt
              }
            }

            Homey.ready();  //ready to show the settings page
          });

	        clearElement.addEventListener('click', function(e) {
	          ipMqttElement.value = "";
	          portMqttElement.value = 1883;
	          usernameMqttElement.value = "";
	          passwordMqttElement.value = "";
	          testResultElement.innerHTML = " ";
	        });

					testElement.addEventListener('click', function(e) {
	          testResultElement.innerHTML = "Testing....";
	          saveData = {
	            ip_mqtt       : ipMqttElement.value,
	            port_mqtt     : portMqttElement.value,
	            username_mqtt : usernameMqttElement.value,
	            password_mqtt : passwordMqttElement.value
	          };
						//test broker settings
						console.log(`testing ${JSON.stringify(saveData)}`);
						Homey.api('POST', '/validate', saveData, function( err, result ) {
						    if( err ) {
									testResultElement.innerHTML = 'error: '+err;
									saveElement.disabled = true;
									return Homey.alert(err, 'error')
								};
								testResultElement.innerHTML =  Homey.__("correctSettings"); //'success: the MQTT settings are correct, now save them!';
								saveElement.disabled = false;
								return Homey.alert(Homey.__("correctSettings"), 'info')
						});

	        });

	        saveElement.addEventListener('click', function(e) {
	          testResultElement.innerHTML = " ";
	          saveData = {
	            ip_mqtt       : ipMqttElement.value,
	            port_mqtt     : portMqttElement.value,
	            username_mqtt : usernameMqttElement.value,
	            password_mqtt : passwordMqttElement.value
	          };
	          Homey.set('settings', saveData, function (error) {
	            if (error) {return Homey.alert(error, 'error')};
							return Homey.alert(Homey.__("settingsSaved"), 'info')
	          });
	        });

					Pw2pySaveElement.addEventListener('click', function(e) {
	          saveData = {
	            ip_pw2py      : ipPw2pyElement.value,
	            port_pw2py    : portPw2pyElement.value,
	          }
	          Homey.set('settings_pw2py', saveData, function (error) {
							if (error) {return Homey.alert(error, 'error')};
							return Homey.alert(Homey.__("settingsSaved"), 'info')
	          });
	        });

	        pw2pyControlElement.addEventListener('click', function(e) {
	          var url = 'http://'+ipPw2pyElement.value+':'+portPw2pyElement.value;
						Homey.openURL( url );
	        });

	        pw2pyConfigElement.addEventListener('click', function(e) {
	          var url = 'http://'+ipPw2pyElement.value+':'+portPw2pyElement.value+'/cfg-pw2py.html';
						Homey.openURL( url );
	        });

				}

        </script>
    </body>
</html>
